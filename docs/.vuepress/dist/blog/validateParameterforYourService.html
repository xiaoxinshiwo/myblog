<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>在项目中通过切面统一进行参数校验 | 博客</title>
    <meta name="description" content="zhangyongxin&#39;s blog">
    <link rel="icon" href="/zhangyongxin/favicon.ico">
    
    <link rel="preload" href="/zhangyongxin/assets/css/styles.419abb40.css" as="style"><link rel="preload" href="/zhangyongxin/assets/js/app.419abb40.js" as="script"><link rel="preload" href="/zhangyongxin/assets/css/styles.419abb40.css" as="style"><link rel="preload" href="/zhangyongxin/assets/js/27.2485ec23.js" as="script"><link rel="preload" href="/zhangyongxin/assets/js/10.6869048d.js" as="script"><link rel="prefetch" href="/zhangyongxin/assets/css/1.styles.ce6d56d0.css"><link rel="prefetch" href="/zhangyongxin/assets/css/9.styles.bc6dcdc9.css"><link rel="prefetch" href="/zhangyongxin/assets/js/1.ce6d56d0.js"><link rel="prefetch" href="/zhangyongxin/assets/js/11.4924cfca.js"><link rel="prefetch" href="/zhangyongxin/assets/js/12.06e0138d.js"><link rel="prefetch" href="/zhangyongxin/assets/js/13.69cd48a7.js"><link rel="prefetch" href="/zhangyongxin/assets/js/14.0ce302da.js"><link rel="prefetch" href="/zhangyongxin/assets/js/15.3f4a03ac.js"><link rel="prefetch" href="/zhangyongxin/assets/js/16.e36ddc95.js"><link rel="prefetch" href="/zhangyongxin/assets/js/17.496bedcc.js"><link rel="prefetch" href="/zhangyongxin/assets/js/18.035aab39.js"><link rel="prefetch" href="/zhangyongxin/assets/js/19.8486cd1a.js"><link rel="prefetch" href="/zhangyongxin/assets/js/2.41263482.js"><link rel="prefetch" href="/zhangyongxin/assets/js/20.325020e4.js"><link rel="prefetch" href="/zhangyongxin/assets/js/21.bdc80faf.js"><link rel="prefetch" href="/zhangyongxin/assets/js/22.502c28b1.js"><link rel="prefetch" href="/zhangyongxin/assets/js/23.bbc47177.js"><link rel="prefetch" href="/zhangyongxin/assets/js/24.98a9ae87.js"><link rel="prefetch" href="/zhangyongxin/assets/js/25.7f615574.js"><link rel="prefetch" href="/zhangyongxin/assets/js/26.4353febb.js"><link rel="prefetch" href="/zhangyongxin/assets/js/28.1a147586.js"><link rel="prefetch" href="/zhangyongxin/assets/js/29.aa1a0ac4.js"><link rel="prefetch" href="/zhangyongxin/assets/js/3.3bf55bee.js"><link rel="prefetch" href="/zhangyongxin/assets/js/30.e0315831.js"><link rel="prefetch" href="/zhangyongxin/assets/js/31.4f3cf23c.js"><link rel="prefetch" href="/zhangyongxin/assets/js/4.9eda696c.js"><link rel="prefetch" href="/zhangyongxin/assets/js/5.3085f65b.js"><link rel="prefetch" href="/zhangyongxin/assets/js/6.59588a53.js"><link rel="prefetch" href="/zhangyongxin/assets/js/7.4f6d4dca.js"><link rel="prefetch" href="/zhangyongxin/assets/js/8.5f48d196.js"><link rel="prefetch" href="/zhangyongxin/assets/js/9.bc6dcdc9.js">
    <link rel="stylesheet" href="/zhangyongxin/assets/css/1.styles.ce6d56d0.css"><link rel="stylesheet" href="/zhangyongxin/assets/css/9.styles.bc6dcdc9.css"><link rel="stylesheet" href="/zhangyongxin/assets/css/styles.419abb40.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div><div class="wrap"><div class="theme-container container no-sidebar"><header class="navbar"><div class="nav-header"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/zhangyongxin/" class="home-link router-link-active"><img src="/zhangyongxin/img/logo.jpg" class="logo"> <span class="site-name can-hide">
        博客
      </span></a> <nav class="nav-links can-hide"><div class="nav-item"><a href="/zhangyongxin/about/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="https://github.com/xiaoxinshiwo" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div> <!----></nav> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div></div></div></header> <div class="sidebar-mask"></div> <div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/zhangyongxin/about/about.html" class="nav-link">About</a></div><div class="nav-item"><a href="https://github.com/xiaoxinshiwo" target="_blank" rel="noopener noreferrer" class="nav-link">Github</a></div> <!----></nav> <!----></div> <div class="page-container"><div><div class="page card"><div class="content-header"><!----> <span class="page-timestamp"></span></div> <div class="content"><h1 id="在项目中通过切面统一进行参数校验"><a href="#在项目中通过切面统一进行参数校验" aria-hidden="true" class="header-anchor">#</a> 在项目中通过切面统一进行参数校验</h1> <div><p>章永新 2018-05-17 18:51:15</p> <hr></div> <blockquote><p>一直以来项目中的参数校验零零散散，散布在controller或者service的方法的开始部分。统一处理可以使代码优雅高效。<br>
另外参数校验在controller做还是service做呢？个人觉得service层才最合理，因为service可以复用。</p></blockquote> <p>下面我们来看看怎么在service层加入切面，在切面上如何进行参数校验吧。<br>
引入依赖:</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;dependency&gt;
  &lt;groupId&gt;org.hibernate.validator&lt;/groupId&gt;
  &lt;artifactId&gt;hibernate-validator&lt;/artifactId&gt;
  &lt;version&gt;6.0.10.Final&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
  &lt;groupId&gt;org.glassfish&lt;/groupId&gt;
  &lt;artifactId&gt;javax.el&lt;/artifactId&gt;
  &lt;version&gt;3.0.1-b09&lt;/version&gt;
&lt;/dependency
</code></pre></div><p>编写model编写需要参数校验的bean:</p> <div class="language- extra-class"><pre class="language-text"><code>package com.xiaoxin.validator.model;

import com.xiaoxin.validator.annotation.Gender;
import lombok.Getter;
import lombok.Setter;
import lombok.ToString;
import org.hibernate.validator.constraints.Length;
import org.springframework.format.annotation.DateTimeFormat;

import javax.validation.constraints.*;
import java.util.Date;

/**
 * @Auther zhangyongxin
 * @date 2018/5/17 上午10:14
 */
@Getter
@Setter
@ToString
public class Student {
    @NotNull(message = &quot;姓名不能为空&quot;)
    private String name;
    //自定义注解限制为 枚举类型 0、1
    @Gender
    private int gender;
    @Length(min=19,max=19,message = &quot;身份证号只能为19位&quot;)
    private String identityId;
    @Pattern(regexp=&quot;^(1)\\d{10}$&quot;, message=&quot;请输入正确的手机号&quot;)
    private String phoneNumber;
    @Email(message = &quot;请输入正确的email地址&quot;)
    private String email;
    @Past(message = &quot;生日不能大于当前时间&quot;)
    @DateTimeFormat(pattern = &quot;yyyMMdd&quot;)
    private Date birthDay;
    @Max(value = 130,message = &quot;年龄不能超过130岁&quot;)
    private int age;
}
</code></pre></div><p>@Gender为自定义限制注解，代码如下：</p> <div class="language- extra-class"><pre class="language-text"><code>package com.xiaoxin.validator.annotation;

import com.xiaoxin.validator.GenderValidator;

import javax.validation.Constraint;
import javax.validation.Payload;
import java.lang.annotation.*;

/**
 * 自定义注解，性别只能为0、1
 * @Auther zhangyongxin
 * @date 2018/5/17 上午10:57
 */
@Target( { ElementType.ANNOTATION_TYPE, ElementType.METHOD, ElementType.FIELD })
@Documented
@Retention(RetentionPolicy.RUNTIME)
@Constraint(validatedBy = {GenderValidator.class})
public @interface Gender {

    String message() default &quot;性别只能为0：女 1：男&quot;;

    Class&lt;?&gt;[] groups() default {};
    Class&lt;? extends Payload&gt;[] payload() default {};

}

</code></pre></div><p>编写@Gender注解validator实现校验任务</p> <div class="language- extra-class"><pre class="language-text"><code>package com.xiaoxin.validator;

import com.xiaoxin.validator.annotation.Gender;

import javax.validation.ConstraintValidator;
import javax.validation.ConstraintValidatorContext;
import java.util.Arrays;

/**
 * 自定义注解相关的validator；性别只能为 0、1
 * @Auther zhangyongxin
 * @date 2018/5/17 上午10:59
 */
public class GenderValidator implements ConstraintValidator&lt;Gender, Integer&gt; {
    private final Integer[] ALL_GENDERS = {0,1};

    @Override
    public boolean isValid(Integer integer, ConstraintValidatorContext constraintValidatorContext) {

        if (Arrays.asList(ALL_GENDERS).contains(integer)) {
            return true;
        }
        return false;
    }
}

</code></pre></div><p>编写自定义注解@NeedValidate用于统一切面处理</p> <div class="language- extra-class"><pre class="language-text"><code>package com.xiaoxin.validator.annotation;

import java.lang.annotation.ElementType;
import java.lang.annotation.Retention;
import java.lang.annotation.RetentionPolicy;
import java.lang.annotation.Target;

/**
 * @Auther zhangyongxin
 * @date 2018/5/18 上午9:30
 */
@Target( {ElementType.METHOD })
@Retention(RetentionPolicy.RUNTIME)
public @interface NeedValidate {
}

</code></pre></div><p>编写service，在需要参数校验的方法参数中增加校验注解，方法的参数如果为基本数据类型需要转换为包装类型。</p> <div class="language- extra-class"><pre class="language-text"><code>package com.xiaoxin.validator.service;

import com.xiaoxin.validator.model.Student;
import org.hibernate.validator.constraints.Length;

import javax.validation.constraints.Max;

/**
 * @Auther zhangyongxin
 * @date 2018/5/17 上午11:04
 */
public interface StudentService {

    Student addOneStudent(Student student,@Length(min=19,max=19)String identityId);

    Student findOneStudent(String identityId);

    void deleteOneStudent(@Length(min=19,max=19)String identityId);

    void updateOneStudentAge(@Length(min=19,max=19)String identityId,
                          @Max(value = 130,message = &quot;年龄不能超过130岁&quot;) Integer age);

}
</code></pre></div><p>编写Service实现类 在需要切面校验的方法上添加@NeedValidate注解</p> <div class="language- extra-class"><pre class="language-text"><code>package com.xiaoxin.validator.service;

import com.xiaoxin.validator.annotation.NeedValidate;
import com.xiaoxin.validator.model.Student;
import com.xiaoxin.validator.service.StudentService;
import lombok.extern.slf4j.Slf4j;
import org.hibernate.validator.constraints.Length;
import org.springframework.stereotype.Service;

import javax.validation.constraints.Max;
import javax.validation.constraints.NotEmpty;
import java.util.Date;

/**
 * @Auther zhangyongxin
 * @date 2018/5/17 上午11:05
 */
@Slf4j
@Service
public class StudentServiceImpl implements StudentService {
    @Override
    public Student addOneStudent(Student student,String identityId) {
        log.info(&quot;add one student:&quot;+student);
        return student;
    }

    @Override
    public Student findOneStudent(String identityId) {
        Student student = new Student();
        student.setBirthDay(new Date());
        student.setEmail(&quot;123@163.com&quot;);
        student.setGender(0);
        student.setPhoneNumber(&quot;13987654320&quot;);
        student.setName(&quot;韩梅&quot;);
        student.setIdentityId(identityId);
        return student;
    }

    @Override
    public void deleteOneStudent(String identityId) {
        log.info(&quot;deleted one student:{}&quot;,identityId);
    }

    @Override
    @NeedValidate
    public void updateOneStudentAge(String identityId,Integer age) {
        log.info(&quot;updateOneStudentAge:{},age:{}&quot;,identityId,age);
    }
}

</code></pre></div><p>编写切面统一处理校验逻辑</p> <div class="language- extra-class"><pre class="language-text"><code>package com.xiaoxin.aop;

import lombok.extern.slf4j.Slf4j;
import org.aspectj.lang.ProceedingJoinPoint;
import org.aspectj.lang.annotation.Around;
import org.aspectj.lang.annotation.Aspect;
import org.aspectj.lang.reflect.MethodSignature;
import org.hibernate.validator.HibernateValidator;
import org.springframework.stereotype.Component;

import javax.validation.ConstraintViolation;
import javax.validation.Validation;
import javax.validation.Validator;
import javax.validation.ValidatorFactory;
import javax.validation.executable.ExecutableValidator;
import java.lang.reflect.Method;
import java.util.HashSet;
import java.util.Set;

/**
 * 参数校验分为bean的和非bean的，bean的参数校验的注解按照代码生成的即可；
 * 非bean的也是使用原来的注解，只不过需要声明在service上。
 *
 * @Auther zhangyongxin
 * @date 2018/5/25 下午1:07
 */
@Slf4j
@Component
@Aspect
public class ParameterValidationAspect {
    private static final String SEMICOLON = &quot;;&quot;;

    //标注了@NeedValidate注解的
    @Around(&quot;@annotation(com.xiaoxin.validator.annotation.NeedValidate)&quot;)
    public Object validateParameters(ProceedingJoinPoint joinPoint) throws Throwable {
        Object[] args = joinPoint.getArgs();
        if (null != args &amp;&amp; args.length &gt; 0) {
            ValidatorFactory validatorFactory = Validation.byProvider(HibernateValidator.class).configure().buildValidatorFactory();
            ExecutableValidator validator = validatorFactory.getValidator().forExecutables();
            Validator beanValidator = validatorFactory.getValidator();
            Set&lt;ConstraintViolation&lt;Object&gt;&gt; violations = new HashSet&lt;&gt;();
            Class clazz = joinPoint.getSignature().getDeclaringType();
            MethodSignature methodSignature = (MethodSignature) joinPoint.getSignature();
            Method targetMethod = methodSignature.getMethod();
            // 非java bean的参数校验
            violations.addAll(validator.validateParameters(clazz.newInstance(), targetMethod, args));
            // java Bean的参数校验
            for (Object object : args) {
                violations.addAll(beanValidator.validate(object));
            }
            dealWithValidations(violations);
        }
        return joinPoint.proceed();

    }

    private void dealWithValidations(Set&lt;ConstraintViolation&lt;Object&gt;&gt; violations) {
        if (violations.size() &gt; 0) {
            StringBuffer buf = new StringBuffer();
            for (ConstraintViolation&lt;Object&gt; violation : violations) {
                buf.append(violation.getPropertyPath().toString());
                buf.append(violation.getMessage());
                buf.append(SEMICOLON);
            }
            throw new IllegalArgumentException(buf.toString());
        }
    }
}



</code></pre></div><p>编写controller进行测试</p> <div class="language- extra-class"><pre class="language-text"><code>package com.xiaoxin.validator.controller;

import com.xiaoxin.validator.model.Result;
import com.xiaoxin.validator.model.ResultGenerator;
import com.xiaoxin.validator.model.Student;
import com.xiaoxin.validator.service.StudentService;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.*;

import javax.validation.Valid;
import javax.validation.constraints.NotEmpty;
import java.util.Date;

/**
 * @Auther zhangyongxin
 * @date 2018/5/17 上午11:51
 */
@RestController
@RequestMapping(&quot;student&quot;)
public class StudentController {
    @Autowired
    private StudentService studentService;

    @PostMapping(&quot;/addOne&quot;)
    public Result addOneStudent(){
        Student student = new Student();
        student.setBirthDay(new Date());
        student.setEmail(&quot;123163.com&quot;);
        student.setGender(0);
        student.setPhoneNumber(&quot;13987654320&quot;);
        student.setName(&quot;韩梅&quot;);
        student.setIdentityId(&quot;3412041900000000000&quot;);
        student = studentService.addOneStudent(student,&quot;&quot;);
        return new Result(student);
    }

    @PostMapping(&quot;/addOneStudent&quot;)
    public Result addOneStudent(@RequestBody @Valid Student student, BindingResult bindingResult){

        /**
         * 参数校验
         */
        if(bindingResult.hasErrors()){
            return ResultGenerator.genValidationResult(bindingResult);
        }
        return new Result(studentService.addOneStudent(student,&quot;3412041900000000000&quot;));
    }

    @GetMapping(&quot;/findOne&quot;)
    public Result findOneStudent(@NotEmpty String identityId){
        Student student =  studentService.findOneStudent(identityId);
        return new Result(student);
    }

    @PostMapping(&quot;/deleteOne&quot;)
    public Result deleteOneStudent(@RequestBody String identityId){
        studentService.deleteOneStudent(identityId);
        return ResultGenerator.genSuccessResult();
    }

    @PostMapping(&quot;/updateAge&quot;)
    public Result updateStudentAge(@RequestParam String identityId,@RequestParam int age){
        studentService.updateOneStudentAge(identityId,age);
        return ResultGenerator.genSuccessResult();
    }
}
</code></pre></div><p>调用测试接口http://127.0.0.1:7788/student/addOne返回结果如下：</p> <div class="language- extra-class"><pre class="language-text"><code>{
&quot;timestamp&quot;: &quot;2018-05-17T11:13:42.651+0000&quot;,
&quot;status&quot;: 500,
&quot;error&quot;: &quot;Internal Server Error&quot;,
&quot;message&quot;: &quot;-email请输入正确的email地址&lt;br/&gt;\n-addOneStudent.arg1长度需要在19和19之间&lt;br/&gt;\n&quot;,
&quot;path&quot;: &quot;/student/addOne&quot;
}
</code></pre></div><p>最后Bean嵌套集合或者Bean的注解写法：</p> <div class="language- extra-class"><pre class="language-text"><code>package org.hibernate.validator.referenceguide.chapter02.objectgraph.containerelement;

public class Car {

    private List&lt;@NotNull @Valid Person&gt; passengers = new ArrayList&lt;Person&gt;();

    private Map&lt;@Valid Part, List&lt;@Valid Manufacturer&gt;&gt; partManufacturers = new HashMap&lt;&gt;();

    //...
}
package org.hibernate.validator.referenceguide.chapter02.objectgraph.containerelement;

public class Part {

    @NotNull
    private String name;

    //...
}
package org.hibernate.validator.referenceguide.chapter02.objectgraph.containerelement;

public class Manufacturer {

    @NotNull
    private String name;

    //...
}
</code></pre></div><p>参考： <a href="http://hibernate.org/validator/" target="_blank" rel="noopener noreferrer">http://hibernate.org/validator/<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p></div> <!----> <div class="content page-nav"><p class="inner"><span class="prev">
          ← <a href="/zhangyongxin/blog/springNotes3.html" class="prev">
            Spring4.3读书笔记3
          </a></span> <span class="next"><a href="/zhangyongxin/blog/whatHappenedWhenNewString/whatHappenedWhenNewString.html">
            从 String str = new String(&quot;abc&quot;);说开去
          </a> →
        </span></p></div></div> <!----></div> <!----></div> <div class="tool-group"><!----></div></div> <!----></div> <div class="background-mask" style="background:url(&quot;https://s1.ax1x.com/2018/11/07/i7AOmV.jpg&quot;) no-repeat fixed;"></div></div></div>
    <script src="/zhangyongxin/assets/js/27.2485ec23.js" defer></script><script src="/zhangyongxin/assets/js/10.6869048d.js" defer></script><script src="/zhangyongxin/assets/js/app.419abb40.js" defer></script>
  </body>
</html>
